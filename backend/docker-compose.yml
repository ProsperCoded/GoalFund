version: "3.8"

services:
  # PostgreSQL databases
  postgres-ledger:
    image: postgis/postgis
    container_name: gofund-postgres-ledger
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ledger_db
    ports:
      - "5433:5432"
    volumes:
      - postgres-ledger-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-goals:
    image: postgis/postgis
    container_name: gofund-postgres-goals
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: goals_db
    ports:
      - "5434:5432"
    volumes:
      - postgres-goals-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-users:
    image: postgis/postgis
    container_name: gofund-postgres-users
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: users_db
    ports:
      - "5435:5432"
    volumes:
      - postgres-users-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-notifications:
    image: postgis/postgis
    container_name: gofund-postgres-notifications
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: notifications_db
    ports:
      - "5436:5432"
    volumes:
      - postgres-notifications-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:4.1-management-alpine
    container_name: gofund-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis
    container_name: gofund-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Datadog Agent
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: gofund-datadog-agent
    environment:
      DD_API_KEY: ${DD_API_KEY}
      DD_SITE: ${DD_SITE:-datadoghq.com}
      DD_APM_ENABLED: "true"
      DD_APM_NON_LOCAL_TRAFFIC: "true"
      DD_LOGS_ENABLED: "true"
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: "true"
      DD_DOGSTATSD_NON_LOCAL_TRAFFIC: "true"
      DD_PROCESS_AGENT_ENABLED: "true"
      DD_CONTAINER_EXCLUDE: "name:datadog-agent"
      DD_TAGS: "env:${DD_ENV:-dev} service:gofund project:gofund"
    ports:
      - "8126:8126" # APM traces
      - "8125:8125/udp" # DogStatsD metrics
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    restart: unless-stopped

  # MongoDB for Payments Service
  mongodb-payments:
    image: mongo:latest
    container_name: gofund-mongodb-payments
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: payments_db
    ports:
      - "27017:27017"
    volumes:
      - mongodb-payments-data:/data/db
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Gateway (Nginx)
  api-gateway:
    image: nginx:alpine
    container_name: gofund-api-gateway
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/proxy_params:/etc/nginx/proxy_params:ro
    ports:
      - "8080:80"
    depends_on:
      - users-service
      - goals-service
      - ledger-service
      - payments-service
      - notifications-service
    restart: unless-stopped

  # Users Service
  users-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_NAME: users-service
    container_name: gofund-users-service
    environment:
      PORT: 8084
      USERS_DB_HOST: postgres-users
      USERS_DB_PORT: 5432
      USERS_DB_USER: postgres
      USERS_DB_PASSWORD: postgres
      USERS_DB_NAME: users_db
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126
      DD_SERVICE: users-service
      DD_ENV: ${DD_ENV:-dev}
      DD_VERSION: ${DD_VERSION:-1.0.0}
    expose:
      - "8084"
    depends_on:
      postgres-users:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    restart: unless-stopped

  # Goals Service
  goals-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_NAME: goals-service
    container_name: gofund-goals-service
    environment:
      PORT: 8083
      GOALS_DB_HOST: postgres-goals
      GOALS_DB_PORT: 5432
      GOALS_DB_USER: postgres
      GOALS_DB_PASSWORD: postgres
      GOALS_DB_NAME: goals_db
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126
      DD_SERVICE: goals-service
      DD_ENV: ${DD_ENV:-dev}
      DD_VERSION: ${DD_VERSION:-1.0.0}
    expose:
      - "8083"
    depends_on:
      postgres-goals:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    restart: unless-stopped

  # Ledger Service
  ledger-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_NAME: ledger-service
    container_name: gofund-ledger-service
    environment:
      PORT: 8082
      LEDGER_DB_HOST: postgres-ledger
      LEDGER_DB_PORT: 5432
      LEDGER_DB_USER: postgres
      LEDGER_DB_PASSWORD: postgres
      LEDGER_DB_NAME: ledger_db
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126
      DD_SERVICE: ledger-service
      DD_ENV: ${DD_ENV:-dev}
      DD_VERSION: ${DD_VERSION:-1.0.0}
    expose:
      - "8082"
    depends_on:
      postgres-ledger:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    restart: unless-stopped

  # Payments Service
  payments-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_NAME: payments-service
    container_name: gofund-payments-service
    environment:
      PORT: 8081
      PAYSTACK_SECRET_KEY: ${PAYSTACK_SECRET_KEY:-}
      PAYSTACK_PUBLIC_KEY: ${PAYSTACK_PUBLIC_KEY:-}
      MONGODB_URI: mongodb://admin:admin123@mongodb-payments:27017/payments_db?authSource=admin
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126
      DD_SERVICE: payments-service
      DD_ENV: ${DD_ENV:-dev}
      DD_VERSION: ${DD_VERSION:-1.0.0}
    expose:
      - "8081"
    depends_on:
      mongodb-payments:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    restart: unless-stopped

  # Notifications Service
  notifications-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_NAME: notifications-service
    container_name: gofund-notifications-service
    environment:
      PORT: 8085
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126
      DD_SERVICE: notifications-service
      DD_ENV: ${DD_ENV:-dev}
      DD_VERSION: ${DD_VERSION:-1.0.0}
      NOTIFICATIONS_DB_HOST: postgres-notifications
      NOTIFICATIONS_DB_PORT: 5432
      NOTIFICATIONS_DB_USER: postgres
      NOTIFICATIONS_DB_PASSWORD: postgres
      NOTIFICATIONS_DB_NAME: notifications_db
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@gofund.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-GoFund}

    expose:
      - "8085"
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres-notifications:
        condition: service_healthy
      datadog-agent:
        condition: service_started

    restart: unless-stopped

volumes:
  postgres-ledger-data:
  postgres-goals-data:
  postgres-users-data:
  mongodb-payments-data:
  rabbitmq-data:
  redis-data:
  postgres-notifications-data:
